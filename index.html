<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel Pirate Plunder</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a2e;
            overflow: hidden;
            touch-action: manipulation;
            font-family: 'Courier New', monospace;
            user-select: none;
            -webkit-user-select: none;
        }
        
        #gameCanvas {
            display: block;
            background: linear-gradient(to bottom, #0f0c29, #302b63);
            margin: 0 auto;
            image-rendering: pixelated;
        }
        
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            font-size: 18px;
            text-shadow: 2px 2px 2px #000;
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
        }
        
        .btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #fff;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: manipulation;
        }
        
        #titleScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #0f0c29, #302b63);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        #title {
            font-size: 48px;
            color: #f8c537;
            text-shadow: 4px 4px 0 #a82b2b;
            margin-bottom: 20px;
        }
        
        #startBtn {
            background: #f8c537;
            color: #1a1a2e;
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        
        #levelSelect {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        
        .levelBtn {
            background: #a82b2b;
            color: #f8c537;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            width: 200px;
        }
        
        #deathScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: #f8c537;
        }
        
        #deathTitle {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        #restartBtn {
            background: #f8c537;
            color: #1a1a2e;
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #levelComplete {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: #f8c537;
        }
        
        #levelCompleteTitle {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        #nextLevelBtn {
            background: #f8c537;
            color: #1a1a2e;
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="ui">
        <div>Gold: <span id="gold">0</span></div>
        <div>Health: <span id="health">100</span></div>
        <div>Level: <span id="level">1</span></div>
    </div>
    
    <div id="controls">
        <div class="btn" id="leftBtn">←</div>
        <div class="btn" id="jumpBtn">↑</div>
        <div class="btn" id="attackBtn">⚔</div>
        <div class="btn" id="rightBtn">→</div>
    </div>
    
    <div id="titleScreen">
        <div id="title">PIXEL PIRATE PLUNDER</div>
        <button id="startBtn">START ADVENTURE</button>
        <div id="levelSelect">
            <button class="levelBtn" data-level="1">Tutorial Island</button>
            <button class="levelBtn" data-level="2">Skull Mountain</button>
            <button class="levelBtn" data-level="3">Ghost Ship</button>
            <button class="levelBtn" data-level="4">Treasure Cove</button>
            <button class="levelBtn" data-level="5">Kraken's Lair</button>
        </div>
    </div>
    
    <div id="deathScreen">
        <div id="deathTitle">YARR, YE BE SUNK!</div>
        <div id="deathStats"></div>
        <button id="restartBtn">SAIL AGAIN</button>
    </div>
    
    <div id="levelComplete">
        <div id="levelCompleteTitle">LEVEL COMPLETE!</div>
        <div id="levelStats"></div>
        <button id="nextLevelBtn">NEXT LEVEL</button>
    </div>

    <script>
        // Game Constants
        const GRAVITY = 0.5;
        const FRICTION = 0.9;
        const PLAYER_SPEED = 5;
        const JUMP_FORCE = -12;
        const LEVEL_COUNT = 5;
        
        // Game State
        const game = {
            player: {
                x: 100,
                y: 300,
                width: 32,
                height: 48,
                velX: 0,
                velY: 0,
                health: 100,
                maxHealth: 100,
                gold: 0,
                isJumping: false,
                isAttacking: false,
                attackCooldown: 0,
                facing: 'right',
                hasCutlass: false,
                hasPistol: false,
                invincible: 0
            },
            camera: {
                x: 0,
                y: 0
            },
            platforms: [],
            enemies: [],
            treasures: [],
            coins: [],
            powerups: [],
            particles: [],
            isRunning: false,
            isGameOver: false,
            keys: {
                left: false,
                right: false,
                up: false,
                attack: false
            },
            worldWidth: 3000,
            worldHeight: 800,
            currentLevel: 1,
            levelComplete: false,
            checkpoint: 0
        };
        
        // Canvas Setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // UI Elements
        const goldDisplay = document.getElementById('gold');
        const healthDisplay = document.getElementById('health');
        const levelDisplay = document.getElementById('level');
        const titleScreen = document.getElementById('titleScreen');
        const deathScreen = document.getElementById('deathScreen');
        const deathStats = document.getElementById('deathStats');
        const levelCompleteScreen = document.getElementById('levelComplete');
        const levelCompleteTitle = document.getElementById('levelCompleteTitle');
        const levelStats = document.getElementById('levelStats');
        
        // Controls
        document.getElementById('leftBtn').addEventListener('touchstart', () => game.keys.left = true);
        document.getElementById('leftBtn').addEventListener('touchend', () => game.keys.left = false);
        document.getElementById('rightBtn').addEventListener('touchstart', () => game.keys.right = true);
        document.getElementById('rightBtn').addEventListener('touchend', () => game.keys.right = false);
        document.getElementById('jumpBtn').addEventListener('touchstart', () => game.keys.up = true);
        document.getElementById('jumpBtn').addEventListener('touchend', () => game.keys.up = false);
        document.getElementById('attackBtn').addEventListener('touchstart', () => game.keys.attack = true);
        
        // Keyboard Controls
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') game.keys.left = true;
            if (e.key === 'ArrowRight') game.keys.right = true;
            if (e.key === 'ArrowUp') game.keys.up = true;
            if (e.key === ' ') game.keys.attack = true;
        });
        
        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft') game.keys.left = false;
            if (e.key === 'ArrowRight') game.keys.right = false;
            if (e.key === 'ArrowUp') game.keys.up = false;
            if (e.key === ' ') game.keys.attack = false;
        });
        
        // Game Start/Restart
        document.getElementById('startBtn').addEventListener('click', () => startGame(1));
        document.getElementById('restartBtn').addEventListener('click', () => startGame(game.currentLevel));
        document.getElementById('nextLevelBtn').addEventListener('click', nextLevel);
        
        // Level selection
        document.querySelectorAll('.levelBtn').forEach(btn => {
            btn.addEventListener('click', () => {
                const level = parseInt(btn.dataset.level);
                startGame(level);
            });
        });
        
        // Game Functions
        function startGame(level) {
            titleScreen.style.display = 'none';
            deathScreen.style.display = 'none';
            levelCompleteScreen.style.display = 'none';
            
            // Reset Game State
            game.player = {
                x: 100,
                y: 300,
                width: 32,
                height: 48,
                velX: 0,
                velY: 0,
                health: 100,
                maxHealth: 100,
                gold: 0,
                isJumping: false,
                isAttacking: false,
                attackCooldown: 0,
                facing: 'right',
                hasCutlass: false,
                hasPistol: false,
                invincible: 0
            };
            
            game.camera = { x: 0, y: 0 };
            game.platforms = [];
            game.enemies = [];
            game.treasures = [];
            game.coins = [];
            game.powerups = [];
            game.particles = [];
            game.isRunning = true;
            game.isGameOver = false;
            game.levelComplete = false;
            game.currentLevel = level;
            game.checkpoint = 0;
            
            // Generate World
            generateLevel(level);
            
            // Update UI
            updateUI();
            
            // Start Game Loop
            requestAnimationFrame(gameLoop);
        }
        
        function nextLevel() {
            if (game.currentLevel < LEVEL_COUNT) {
                startGame(game.currentLevel + 1);
            } else {
                // Game complete!
                levelCompleteTitle.textContent = "CONGRATULATIONS!";
                levelStats.innerHTML = `
                    <div>You've completed all levels!</div>
                    <div>Total Gold: ${game.player.gold}</div>
                `;
                document.getElementById('nextLevelBtn').textContent = "PLAY AGAIN";
                startGame(1);
            }
        }
        
        function generateLevel(level) {
            game.worldWidth = 2000 + (level * 500); // Increase world size with each level
            levelDisplay.textContent = level;
            
            // Ground
            game.platforms.push({ x: 0, y: 600, width: game.worldWidth, height: 50 });
            
            // Level-specific generation
            switch(level) {
                case 1: // Tutorial Island
                    // Basic platforms
                    for (let i = 0; i < 10; i++) {
                        game.platforms.push({
                            x: 200 + i * 150,
                            y: 500 - (i % 3) * 50,
                            width: 100,
                            height: 20
                        });
                    }
                    
                    // Coins
                    for (let i = 0; i < 30; i++) {
                        game.coins.push({
                            x: 150 + Math.random() * (game.worldWidth - 300),
                            y: 300 + Math.random() * 200,
                            width: 15,
                            height: 15,
                            value: 1,
                            spin: 0
                        });
                    }
                    
                    // Easy enemies
                    for (let i = 0; i < 5; i++) {
                        game.enemies.push({
                            x: 300 + i * 300,
                            y: 550,
                            width: 32,
                            height: 48,
                            velX: Math.random() > 0.5 ? 1 : -1,
                            health: 20,
                            type: 'skeleton'
                        });
                    }
                    
                    // First power-up (cutlass)
                    game.powerups.push({
                        x: 800,
                        y: 450,
                        width: 20,
                        height: 20,
                        type: 'cutlass'
                    });
                    
                    // Level end (treasure chest)
                    game.treasures.push({
                        x: game.worldWidth - 100,
                        y: 500,
                        width: 40,
                        height: 30,
                        value: 50,
                        isExit: true
                    });
                    break;
                    
                case 2: // Skull Mountain
                    // Mountain platforms
                    for (let i = 0; i < 15; i++) {
                        game.platforms.push({
                            x: 100 + i * 120,
                            y: 550 - (i % 4) * 80,
                            width: 80 + Math.random() * 40,
                            height: 20
                        });
                    }
                    
                    // Vertical platforms
                    for (let i = 0; i < 5; i++) {
                        game.platforms.push({
                            x: 600 + i * 200,
                            y: 400,
                            width: 20,
                            height: 200,
                            isWall: true
                        });
                    }
                    
                    // Coins in patterns
                    for (let i = 0; i < 10; i++) {
                        for (let j = 0; j < 3; j++) {
                            game.coins.push({
                                x: 300 + i * 150,
                                y: 400 - j * 30,
                                width: 15,
                                height: 15,
                                value: 1,
                                spin: 0
                            });
                        }
                    }
                    
                    // More enemies
                    for (let i = 0; i < 8; i++) {
                        game.enemies.push({
                            x: 200 + i * 250,
                            y: 550 - (i % 3) * 80,
                            width: 32,
                            height: 48,
                            velX: Math.random() > 0.5 ? 1.5 : -1.5,
                            health: 30,
                            type: 'skeleton'
                        });
                    }
                    
                    // Power-up (pistol)
                    game.powerups.push({
                        x: 1200,
                        y: 350,
                        width: 20,
                        height: 20,
                        type: 'pistol'
                    });
                    
                    // Level end
                    game.treasures.push({
                        x: game.worldWidth - 100,
                        y: 400,
                        width: 40,
                        height: 30,
                        value: 100,
                        isExit: true
                    });
                    break;
                    
                case 3: // Ghost Ship
                    // Ship deck platforms
                    game.platforms.push({ x: 0, y: 400, width: game.worldWidth, height: 20 });
                    
                    // Ship masts and sails
                    for (let i = 0; i < 3; i++) {
                        game.platforms.push({
                            x: 300 + i * 500,
                            y: 200,
                            width: 20,
                            height: 200,
                            isWall: true
                        });
                        
                        // Sail platforms
                        game.platforms.push({
                            x: 300 + i * 500 - 50,
                            y: 300,
                            width: 120,
                            height: 10,
                            isSail: true
                        });
                    }
                    
                    // Coins
                    for (let i = 0; i < 40; i++) {
                        game.coins.push({
                            x: 100 + Math.random() * (game.worldWidth - 200),
                            y: 200 + Math.random() * 150,
                            width: 15,
                            height: 15,
                            value: 1,
                            spin: 0
                        });
                    }
                    
                    // Flying enemies
                    for (let i = 0; i < 6; i++) {
                        game.enemies.push({
                            x: 200 + i * 300,
                            y: 300 + Math.sin(i) * 100,
                            width: 32,
                            height: 32,
                            velX: Math.random() > 0.5 ? 2 : -2,
                            velY: 0.5,
                            health: 25,
                            type: 'ghost'
                        });
                    }
                    
                    // Level end
                    game.treasures.push({
                        x: game.worldWidth - 100,
                        y: 350,
                        width: 40,
                        height: 30,
                        value: 150,
                        isExit: true
                    });
                    break;
                    
                case 4: // Treasure Cove
                    // Island platforms
                    for (let i = 0; i < 20; i++) {
                        game.platforms.push({
                            x: 100 + i * 100,
                            y: 550 - Math.sin(i/3) * 100,
                            width: 80 + Math.random() * 40,
                            height: 20
                        });
                    }
                    
                    // Water sections (danger zones)
                    for (let i = 0; i < 5; i++) {
                        game.platforms.push({
                            x: 200 + i * 350,
                            y: 600,
                            width: 200,
                            height: 20,
                            isWater: true
                        });
                    }
                    
                    // Lots of coins
                    for (let i = 0; i < 50; i++) {
                        game.coins.push({
                            x: 100 + Math.random() * (game.worldWidth - 200),
                            y: 300 + Math.random() * 200,
                            width: 15,
                            height: 15,
                            value: 1,
                            spin: 0
                        });
                    }
                    
                    // Treasure chests
                    for (let i = 0; i < 5; i++) {
                        game.treasures.push({
                            x: 300 + i * 400,
                            y: 450,
                            width: 30,
                            height: 20,
                            value: 20
                        });
                    }
                    
                    // Enemies
                    for (let i = 0; i < 10; i++) {
                        game.enemies.push({
                            x: 200 + i * 200,
                            y: 550 - Math.sin(i/2) * 100,
                            width: 32,
                            height: 48,
                            velX: Math.random() > 0.5 ? 2 : -2,
                            health: 40,
                            type: 'skeleton'
                        });
                    }
                    
                    // Level end
                    game.treasures.push({
                        x: game.worldWidth - 100,
                        y: 450,
                        width: 40,
                        height: 30,
                        value: 200,
                        isExit: true
                    });
                    break;
                    
                case 5: // Kraken's Lair
                    // Floating platforms
                    for (let i = 0; i < 25; i++) {
                        game.platforms.push({
                            x: 100 + i * 120,
                            y: 500 - Math.sin(i/2) * 150,
                            width: 70,
                            height: 15,
                            isFloating: true,
                            floatOffset: Math.random() * Math.PI * 2
                        });
                    }
                    
                    // Coins
                    for (let i = 0; i < 60; i++) {
                        game.coins.push({
                            x: 100 + Math.random() * (game.worldWidth - 200),
                            y: 200 + Math.random() * 300,
                            width: 15,
                            height: 15,
                            value: 1,
                            spin: 0
                        });
                    }
                    
                    // Boss enemy (kraken tentacles)
                    for (let i = 0; i < 4; i++) {
                        game.enemies.push({
                            x: 500 + i * 400,
                            y: 300,
                            width: 30,
                            height: 200,
                            velX: 0,
                            velY: Math.sin(i) * 2,
                            health: 100,
                            type: 'tentacle'
                        });
                    }
                    
                    // Level end
                    game.treasures.push({
                        x: game.worldWidth - 100,
                        y: 400,
                        width: 60,
                        height: 40,
                        value: 500,
                        isExit: true
                    });
                    break;
            }
            
            // Checkpoint flags
            for (let i = 1; i < 3; i++) {
                game.treasures.push({
                    x: (game.worldWidth / 3) * i,
                    y: 550,
                    width: 20,
                    height: 40,
                    isCheckpoint: true,
                    checkpointId: i
                });
            }
        }
        
        function update() {
            // Player Movement
            if (game.keys.left) {
                game.player.velX = -PLAYER_SPEED;
                game.player.facing = 'left';
            } else if (game.keys.right) {
                game.player.velX = PLAYER_SPEED;
                game.player.facing = 'right';
            } else {
                game.player.velX *= FRICTION;
            }
            
            // Jumping
            if (game.keys.up && !game.player.isJumping) {
                game.player.velY = JUMP_FORCE;
                game.player.isJumping = true;
                createParticles(game.player.x + game.player.width/2, game.player.y + game.player.height, 10, '#f8c537');
            }
            
            // Gravity
            game.player.velY += GRAVITY;
            
            // Update Position
            game.player.x += game.player.velX;
            game.player.y += game.player.velY;
            
            // Invincibility frames
            if (game.player.invincible > 0) {
                game.player.invincible--;
            }
            
            // Camera Follow
            game.camera.x = game.player.x - canvas.width/3;
            game.camera.y = game.player.y - canvas.height/2;
            
            // Boundary Checks
            if (game.player.x < 0) game.player.x = 0;
            if (game.player.x > game.worldWidth - game.player.width) game.player.x = game.worldWidth - game.player.width;
            if (game.player.y > game.worldHeight - game.player.height) {
                game.player.y = game.worldHeight - game.player.height;
                game.player.velY = 0;
                game.player.isJumping = false;
            }
            
            // Platform Collisions
            let onGround = false;
            let inWater = false;
            game.platforms.forEach(platform => {
                if (collision(game.player, platform)) {
                    // Top collision
                    if (game.player.velY > 0 && game.player.y + game.player.height < platform.y + 10) {
                        game.player.y = platform.y - game.player.height;
                        game.player.velY = 0;
                        game.player.isJumping = false;
                        onGround = true;
                        
                        // Bounce on floating platforms
                        if (platform.isFloating) {
                            game.player.velY = JUMP_FORCE * 0.8;
                        }
                        
                        // Water damage
                        if (platform.isWater) {
                            inWater = true;
                        }
                    }
                    // Bottom collision
                    else if (game.player.velY < 0 && game.player.y > platform.y + platform.height - 10) {
                        game.player.y = platform.y + platform.height;
                        game.player.velY = 0;
                    }
                    // Left/right collision for walls
                    else if (platform.isWall) {
                        if (game.player.velX > 0 && game.player.x + game.player.width < platform.x + 10) {
                            game.player.x = platform.x - game.player.width;
                            game.player.velX = 0;
                        } else if (game.player.velX < 0 && game.player.x > platform.x + platform.width - 10) {
                            game.player.x = platform.x + platform.width;
                            game.player.velX = 0;
                        }
                    }
                }
                
                // Floating platform movement
                if (platform.isFloating) {
                    platform.floatOffset += 0.02;
                    platform.y = 500 - Math.sin(platform.floatOffset) * 20;
                }
            });
            
            if (!onGround) game.player.isJumping = true;
            
            // Water damage
            if (inWater && game.player.invincible <= 0) {
                game.player.health -= 1;
                game.player.invincible = 10;
                if (game.player.health <= 0) gameOver();
            }
            
            // Attack
            if (game.keys.attack && game.player.attackCooldown <= 0) {
                game.player.isAttacking = true;
                game.player.attackCooldown = game.player.hasPistol ? 30 : 20;
                
                // Check enemy hits
                game.enemies.forEach(enemy => {
                    let attackRange;
                    
                    if (game.player.hasPistol) {
                        // Pistol attack (projectile)
                        game.particles.push({
                            x: game.player.facing === 'right' ? game.player.x + game.player.width : game.player.x - 10,
                            y: game.player.y + game.player.height/2,
                            size: 5,
                            velX: game.player.facing === 'right' ? 10 : -10,
                            velY: 0,
                            color: '#ffcc00',
                            life: 30,
                            maxLife: 30,
                            isBullet: true,
                            damage: 15
                        });
                    } else {
                        // Melee attack
                        attackRange = {
                            x: game.player.facing === 'right' ? game.player.x + game.player.width : game.player.x - 40,
                            y: game.player.y,
                            width: 40,
                            height: game.player.height
                        };
                        
                        if (collision(attackRange, enemy)) {
                            enemy.health -= game.player.hasCutlass ? 20 : 10;
                            createParticles(enemy.x + enemy.width/2, enemy.y + enemy.height/2, 15, '#ff0000');
                            
                            if (enemy.health <= 0) {
                                // Drop coins
                                const coinsToDrop = enemy.type === 'tentacle' ? 10 : 3;
                                for (let i = 0; i < coinsToDrop; i++) {
                                    game.coins.push({
                                        x: enemy.x + enemy.width/2,
                                        y: enemy.y + enemy.height/2,
                                        width: 10,
                                        height: 10,
                                        value: 1,
                                        spin: 0,
                                        velX: -2 + Math.random() * 4,
                                        velY: -2 - Math.random() * 2
                                    });
                                }
                            }
                        }
                    }
                });
                
                createParticles(
                    game.player.facing === 'right' ? game.player.x + game.player.width : game.player.x - 10,
                    game.player.y + game.player.height/2,
                    8, '#ffffff'
                );
            }
            
            if (game.player.attackCooldown > 0) {
                game.player.attackCooldown--;
            } else {
                game.player.isAttacking = false;
            }
            
            // Bullet collisions
            game.particles.forEach(particle => {
                if (particle.isBullet) {
                    game.enemies.forEach(enemy => {
                        if (collision(particle, enemy)) {
                            enemy.health -= particle.damage;
                            createParticles(enemy.x + enemy.width/2, enemy.y + enemy.height/2, 15, '#ff0000');
                            particle.life = 0;
                            
                            if (enemy.health <= 0) {
                                // Drop coins
                                const coinsToDrop = enemy.type === 'tentacle' ? 10 : 3;
                                for (let i = 0; i < coinsToDrop; i++) {
                                    game.coins.push({
                                        x: enemy.x + enemy.width/2,
                                        y: enemy.y + enemy.height/2,
                                        width: 10,
                                        height: 10,
                                        value: 1,
                                        spin: 0,
                                        velX: -2 + Math.random() * 4,
                                        velY: -2 - Math.random() * 2
                                    });
                                }
                            }
                        }
                    });
                }
            });
            
            // Enemy AI
            game.enemies = game.enemies.filter(enemy => enemy.health > 0);
            game.enemies.forEach(enemy => {
                // Movement based on type
                switch(enemy.type) {
                    case 'skeleton':
                        enemy.x += enemy.velX;
                        
                        // Simple patrol
                        let onEdge = true;
                        game.platforms.forEach(platform => {
                            if (!platform.isWall && !platform.isFloating && !platform.isWater) {
                                if (enemy.x + enemy.width > platform.x && enemy.x < platform.x + platform.width &&
                                    enemy.y + enemy.height <= platform.y + 5 && enemy.y + enemy.height >= platform.y - 5) {
                                    onEdge = false;
                                }
                            }
                        });
                        
                        if (onEdge) enemy.velX *= -1;
                        break;
                        
                    case 'ghost':
                        enemy.x += enemy.velX;
                        enemy.y += enemy.velY;
                        
                        // Bounce around
                        if (enemy.y < 200 || enemy.y > 400) enemy.velY *= -1;
                        break;
                        
                    case 'tentacle':
                        enemy.y += enemy.velY;
                        if (enemy.y < 200 || enemy.y > 400) enemy.velY *= -1;
                        break;
                }
                
                // Damage player if touching
                if (collision(game.player, enemy) {
                    if (game.player.invincible <= 0) {
                        game.player.health -= enemy.type === 'tentacle' ? 5 : 1;
                        game.player.invincible = 30;
                        if (game.player.health <= 0) gameOver();
                    }
                }
            });
            
            // Coin Collection
            game.coins.forEach(coin => {
                coin.spin += 0.1;
                
                // Apply physics if they have velocity
                if (coin.velX !== undefined) {
                    coin.x += coin.velX;
                    coin.y += coin.velY;
                    coin.velY += 0.1;
                    coin.velX *= 0.98;
                }
            });
            
            game.coins = game.coins.filter(coin => {
                if (collision(game.player, coin)) {
                    game.player.gold += coin.value;
                    createParticles(coin.x + coin.width/2, coin.y + coin.height/2, 5, '#f8c537');
                    updateUI();
                    return false;
                }
                return true;
            });
            
            // Treasure Collection
            game.treasures = game.treasures.filter(treasure => {
                if (collision(game.player, treasure)) {
                    if (treasure.isExit) {
                        // Level complete!
                        levelComplete();
                        return true;
                    } else if (treasure.isCheckpoint) {
                        // Set checkpoint
                        game.checkpoint = treasure.checkpointId;
                        createParticles(treasure.x + treasure.width/2, treasure.y, 20, '#ffffff');
                        return true;
                    } else {
                        // Regular treasure
                        game.player.gold += treasure.value;
                        createParticles(treasure.x + treasure.width/2, treasure.y + treasure.height/2, 10, '#f8c537');
                        updateUI();
                        return false;
                    }
                }
                return true;
            });
            
            // Powerup Collection
            game.powerups = game.powerups.filter(powerup => {
                if (collision(game.player, powerup)) {
                    if (powerup.type === 'cutlass') {
                        game.player.hasCutlass = true;
                        createParticles(powerup.x + powerup.width/2, powerup.y + powerup.height/2, 20, '#00ff00');
                    } else if (powerup.type === 'pistol') {
                        game.player.hasPistol = true;
                        createParticles(powerup.x + powerup.width/2, powerup.y + powerup.height/2, 20, '#0000ff');
                    }
                    return false;
                }
                return true;
            });
            
            // Update Particles
            game.particles.forEach(p => {
                p.x += p.velX;
                p.y += p.velY;
                p.life--;
            });
            game.particles = game.particles.filter(p => p.life > 0);
        }
        
        function render() {
            // Clear Canvas
            ctx.fillStyle = '#0f0c29';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw Parallax Background
            drawBackground();
            
            // Draw World (offset by camera)
            ctx.save();
            ctx.translate(-game.camera.x, -game.camera.y);
            
            // Draw Platforms
            game.platforms.forEach(platform => {
                if (platform.isCave) {
                    // Cave entrance
                    ctx.fillStyle = '#3a2c1a';
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                    
                    // Cave interior shadow
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.beginPath();
                    ctx.arc(platform.x + platform.width/2, platform.y + 10, platform.width/2 - 5, 0, Math.PI, true);
                    ctx.fill();
                } else if (platform.isWall) {
                    // Ship mast/wall
                    ctx.fillStyle = '#5d4037';
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                    
                    // Wood grain
                    ctx.fillStyle = '#3e2723';
                    for (let y = platform.y; y < platform.y + platform.height; y += 10) {
                        ctx.beginPath();
                        ctx.moveTo(platform.x, y);
                        ctx.bezierCurveTo(
                            platform.x + 5, y + 5,
                            platform.x + 15, y - 5,
                            platform.x + platform.width, y
                        );
                        ctx.stroke();
                    }
                } else if (platform.isSail) {
                    // Sail
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                    
                    // Sail stripes
                    ctx.fillStyle = '#e0e0e0';
                    for (let x = platform.x; x < platform.x + platform.width; x += 15) {
                        ctx.fillRect(x, platform.y, 5, platform.height);
                    }
                } else if (platform.isWater) {
                    // Water
                    ctx.fillStyle = '#1e88e5';
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                    
                    // Water waves
                    ctx.strokeStyle = '#64b5f6';
                    ctx.lineWidth = 2;
                    for (let x = platform.x; x < platform.x + platform.width; x += 30) {
                        ctx.beginPath();
                        ctx.moveTo(x, platform.y + 10);
                        ctx.quadraticCurveTo(x + 15, platform.y, x + 30, platform.y + 10);
                        ctx.stroke();
                    }
                } else if (platform.isFloating) {
                    // Floating platform
                    ctx.fillStyle = '#8d6e63';
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                    
                    // Rope sides
                    ctx.strokeStyle = '#5d4037';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(platform.x, platform.y);
                    ctx.lineTo(platform.x, platform.y + platform.height);
                    ctx.moveTo(platform.x + platform.width, platform.y);
                    ctx.lineTo(platform.x + platform.width, platform.y + platform.height);
                    ctx.stroke();
                } else {
                    // Regular platform
                    ctx.fillStyle = '#5d4037';
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                    
                    // Platform detail
                    ctx.fillStyle = '#3e2723';
                    for (let i = 0; i < platform.width; i += 10) {
                        ctx.fillRect(platform.x + i, platform.y, 5, 3);
                    }
                }
            });
            
            // Draw Coins
            game.coins.forEach(coin => {
                ctx.save();
                ctx.translate(coin.x + coin.width/2, coin.y + coin.height/2);
                ctx.rotate(coin.spin);
                
                ctx.fillStyle = '#f8c537';
                ctx.beginPath();
                ctx.arc(0, 0, coin.width/2, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.beginPath();
                ctx.arc(-3, -3, 3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
            });
            
            // Draw Treasures
            game.treasures.forEach(treasure => {
                if (treasure.isExit) {
                    // Treasure chest (exit)
                    ctx.fillStyle = '#f8c537';
                    ctx.fillRect(treasure.x, treasure.y, treasure.width, treasure.height);
                    
                    // Chest details
                    ctx.fillStyle = '#a82b2b';
                    ctx.fillRect(treasure.x, treasure.y, treasure.width, 8);
                    ctx.fillRect(treasure.x + 5, treasure.y + 8, treasure.width - 10, 4);
                    
                    // Lock
                    ctx.fillStyle = '#5d4037';
                    ctx.beginPath();
                    ctx.arc(treasure.x + treasure.width/2, treasure.y + 15, 5, 0, Math.PI * 2);
                    ctx.fill();
                } else if (treasure.isCheckpoint) {
                    // Checkpoint flag
                    ctx.fillStyle = '#a82b2b';
                    ctx.fillRect(treasure.x, treasure.y, 5, treasure.height);
                    
                    ctx.fillStyle = '#f8c537';
                    ctx.beginPath();
                    ctx.moveTo(treasure.x + 5, treasure.y + 10);
                    ctx.lineTo(treasure.x + treasure.width, treasure.y + 20);
                    ctx.lineTo(treasure.x + 5, treasure.y + 30);
                    ctx.fill();
                } else {
                    // Regular treasure
                    ctx.fillStyle = '#f8c537';
                    ctx.fillRect(treasure.x, treasure.y, treasure.width, treasure.height);
                    
                    // Shine effect
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.beginPath();
                    ctx.moveTo(treasure.x + 5, treasure.y + 5);
                    ctx.lineTo(treasure.x + 15, treasure.y + 5);
                    ctx.lineTo(treasure.x + 5, treasure.y + 15);
                    ctx.fill();
                }
            });
            
            // Draw Powerups
            game.powerups.forEach(powerup => {
                if (powerup.type === 'cutlass') {
                    // Cutlass powerup
                    ctx.fillStyle = '#00ff00';
                    ctx.fillRect(powerup.x, powerup.y, powerup.width, powerup.height);
                    
                    // Sword icon
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(powerup.x + 5, powerup.y + 5, 10, 2);
                    ctx.fillRect(powerup.x + 8, powerup.y, 4, 10);
                } else if (powerup.type === 'pistol') {
                    // Pistol powerup
                    ctx.fillStyle = '#0000ff';
                    ctx.fillRect(powerup.x, powerup.y, powerup.width, powerup.height);
                    
                    // Gun icon
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(powerup.x + 5, powerup.y + 8, 10, 4);
                    ctx.fillRect(powerup.x + 12, powerup.y + 5, 3, 10);
                }
            });
            
            // Draw Enemies
            game.enemies.forEach(enemy => {
                if (enemy.type === 'skeleton') {
                    // Skeleton enemy
                    ctx.fillStyle = '#e0e0e0';
                    ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
                    
                    // Head
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(enemy.x + 8, enemy.y - 10, 16, 10);
                    
                    // Eyes
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(enemy.x + 12, enemy.y - 7, 4, 4);
                    ctx.fillRect(enemy.x + 20, enemy.y - 7, 4, 4);
                    
                    // Health bar
                    ctx.fillStyle = '#ff0000';
                    ctx.fillRect(enemy.x, enemy.y - 15, enemy.width, 3);
                    ctx.fillStyle = '#00ff00';
                    ctx.fillRect(enemy.x, enemy.y - 15, enemy.width * (enemy.health / 30), 3);
                } else if (enemy.type === 'ghost') {
                    // Ghost enemy
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.beginPath();
                    ctx.moveTo(enemy.x + enemy.width/2, enemy.y);
                    ctx.lineTo(enemy.x + enemy.width, enemy.y + enemy.height - 10);
                    ctx.lineTo(enemy.x + enemy.width/2, enemy.y + enemy.height);
                    ctx.lineTo(enemy.x, enemy.y + enemy.height - 10);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Eyes
                    ctx.fillStyle = '#000000';
                    ctx.beginPath();
                    ctx.arc(enemy.x + enemy.width/3, enemy.y + enemy.height/3, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(enemy.x + (enemy.width/3)*2, enemy.y + enemy.height/3, 3, 0, Math.PI * 2);
                    ctx.fill();
                } else if (enemy.type === 'tentacle') {
                    // Kraken tentacle
                    ctx.fillStyle = '#6a1b9a';
                    ctx.beginPath();
                    ctx.moveTo(enemy.x + enemy.width/2, enemy.y);
                    ctx.quadraticCurveTo(
                        enemy.x + enemy.width, enemy.y + enemy.height/2,
                        enemy.x + enemy.width/2, enemy.y + enemy.height
                    );
                    ctx.quadraticCurveTo(
                        enemy.x, enemy.y + enemy.height/2,
                        enemy.x + enemy.width/2, enemy.y
                    );
                    ctx.fill();
                    
                    // Suckers
                    ctx.fillStyle = '#9c27b0';
                    for (let y = enemy.y + 20; y < enemy.y + enemy.height; y += 30) {
                        ctx.beginPath();
                        ctx.arc(enemy.x + enemy.width/2, y, 8, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    // Health bar
                    ctx.fillStyle = '#ff0000';
                    ctx.fillRect(enemy.x - 10, enemy.y - 15, enemy.width + 20, 5);
                    ctx.fillStyle = '#00ff00';
                    ctx.fillRect(enemy.x - 10, enemy.y - 15, (enemy.width + 20) * (enemy.health / 100), 5);
                }
            });
            
            // Draw Player
            if (game.player.invincible <= 0 || Math.floor(game.player.invincible / 5) % 2 === 0) {
                ctx.fillStyle = '#8d6e63'; // Coat
                ctx.fillRect(game.player.x, game.player.y, game.player.width, game.player.height);
                
                // Head
                ctx.fillStyle = '#ffdbac';
                ctx.fillRect(game.player.x + 8, game.player.y - 10, 16, 10);
                
                // Hat
                ctx.fillStyle = '#a82b2b';
                ctx.fillRect(game.player.x + 4, game.player.y - 15, 24, 5);
                ctx.fillRect(game.player.x + 12, game.player.y - 25, 8, 10);
                
                // Eye patch
                if (game.player.facing === 'right') {
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(game.player.x + 12, game.player.y - 7, 6, 3);
                } else {
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(game.player.x + 18, game.player.y - 7, 6, 3);
                }
                
                // Weapons
                if (game.player.hasCutlass) {
                    ctx.fillStyle = '#cccccc';
                    ctx.fillRect(game.player.x + game.player.width - 5, game.player.y + 10, 20, 3);
                }
                
                if (game.player.hasPistol) {
                    ctx.fillStyle = '#5d4037';
                    ctx.fillRect(game.player.x + 5, game.player.y + 15, 15, 5);
                }
                
                // Sword when attacking
                if (game.player.isAttacking && game.player.hasCutlass) {
                    ctx.fillStyle = '#cccccc';
                    if (game.player.facing === 'right') {
                        ctx.fillRect(game.player.x + game.player.width, game.player.y + 10, 30, 5);
                    } else {
                        ctx.fillRect(game.player.x - 30, game.player.y + 10, 30, 5);
                    }
                }
            }
            
            // Draw Particles
            game.particles.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life / p.maxLife;
                
                if (p.isBullet) {
                    // Draw bullet
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    // Regular particle
                    ctx.fillRect(p.x, p.y, p.size, p.size);
                }
            });
            ctx.globalAlpha = 1;
            
            ctx.restore();
        }
        
        function drawBackground() {
            // Stars
            ctx.fillStyle = '#ffffff';
            for (let i = 0; i < 100; i++) {
                const x = (i * 50 + game.camera.x * 0.1) % canvas.width;
                const y = (i * 37) % canvas.height;
                const size = 1 + Math.random();
                ctx.fillRect(x, y, size, size);
            }
            
            // Moon
            ctx.fillStyle = '#f5f5f5';
            ctx.beginPath();
            ctx.arc(canvas.width - 100 - game.camera.x * 0.05, 100, 30, 0, Math.PI * 2);
            ctx.fill();
            
            // Clouds
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            for (let i = 0; i < 5; i++) {
                const x = (i * 400 + game.camera.x * 0.1) % (canvas.width + 400) - 200;
                const y = 150 + Math.sin(i) * 50;
                
                ctx.beginPath();
                ctx.arc(x, y, 30, 0, Math.PI * 2);
                ctx.arc(x + 25, y - 10, 25, 0, Math.PI * 2);
                ctx.arc(x + 50, y, 20, 0, Math.PI * 2);
                ctx.arc(x + 25, y + 10, 25, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Level-specific background elements
            switch(game.currentLevel) {
                case 2: // Skull Mountain
                    // Mountains
                    ctx.fillStyle = '#1b5e20';
                    ctx.beginPath();
                    ctx.moveTo(0 - game.camera.x * 0.2, canvas.height);
                    ctx.lineTo(0 - game.camera.x * 0.2, canvas.height - 150);
                    ctx.lineTo(200 - game.camera.x * 0.2, canvas.height - 200);
                    ctx.lineTo(400 - game.camera.x * 0.2, canvas.height - 170);
                    ctx.lineTo(600 - game.camera.x * 0.2, canvas.height - 230);
                    ctx.lineTo(800 - game.camera.x * 0.2, canvas.height - 150);
                    ctx.lineTo(1000 - game.camera.x * 0.2, canvas.height - 190);
                    ctx.lineTo(canvas.width, canvas.height);
                    ctx.fill();
                    
                    // Skull cave
                    ctx.fillStyle = '#000000';
                    ctx.beginPath();
                    ctx.arc(800 - game.camera.x * 0.2, canvas.height - 230, 60, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Eyes
                    ctx.fillStyle = '#ff0000';
                    ctx.beginPath();
                    ctx.arc(780 - game.camera.x * 0.2, canvas.height - 240, 10, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(820 - game.camera.x * 0.2, canvas.height - 240, 10, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                    
                case 3: // Ghost Ship
                    // Ocean waves
                    ctx.fillStyle = '#0d47a1';
                    ctx.beginPath();
                    ctx.moveTo(0, canvas.height - 50);
                    for (let x = 0; x < canvas.width; x += 50) {
                        ctx.lineTo(x, canvas.height - 50 + Math.sin(x/50 + Date.now()/1000) * 10);
                    }
                    ctx.lineTo(canvas.width, canvas.height);
                    ctx.lineTo(0, canvas.height);
                    ctx.closePath();
                    ctx.fill();
                    break;
                    
                case 4: // Treasure Cove
                    // Palm trees
                    for (let i = 0; i < 3; i++) {
                        const treeX = (i * 400 + game.camera.x * 0.1) % (canvas.width + 400) - 200;
                        
                        // Trunk
                        ctx.fillStyle = '#5d4037';
                        ctx.fillRect(treeX, canvas.height - 100, 20, 100);
                        
                        // Leaves
                        ctx.fillStyle = '#2e7d32';
                        ctx.beginPath();
                        ctx.arc(treeX + 10, canvas.height - 120, 40, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(treeX - 20, canvas.height - 110, 30, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(treeX + 40, canvas.height - 110, 30, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    break;
                    
                case 5: // Kraken's Lair
                    // Underwater bubbles
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    for (let i = 0; i < 20; i++) {
                        const x = (i * 100 + game.camera.x * 0.05) % canvas.width;
                        const y = canvas.height - 100 + Math.sin(i + Date.now()/1000) * 50;
                        const size = 5 + Math.random() * 10;
                        
                        ctx.beginPath();
                        ctx.arc(x, y, size, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    break;
                    
                default:
                    // Default mountains
                    ctx.fillStyle = '#1b5e20';
                    ctx.beginPath();
                    ctx.moveTo(0 - game.camera.x * 0.2, canvas.height);
                    ctx.lineTo(0 - game.camera.x * 0.2, canvas.height - 100);
                    ctx.lineTo(200 - game.camera.x * 0.2, canvas.height - 150);
                    ctx.lineTo(400 - game.camera.x * 0.2, canvas.height - 120);
                    ctx.lineTo(600 - game.camera.x * 0.2, canvas.height - 180);
                    ctx.lineTo(800 - game.camera.x * 0.2, canvas.height - 100);
                    ctx.lineTo(1000 - game.camera.x * 0.2, canvas.height - 140);
                    ctx.lineTo(canvas.width, canvas.height);
                    ctx.fill();
                    break;
            }
        }
        
        function createParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                game.particles.push({
                    x: x,
                    y: y,
                    size: 2 + Math.random() * 4,
                    velX: -2 + Math.random() * 4,
                    velY: -2 + Math.random() * 4,
                    color: color,
                    life: 10 + Math.random() * 20,
                    maxLife: 30
                });
            }
        }
        
        function collision(a, b) {
            return a.x < b.x + b.width &&
                   a.x + a.width > b.x &&
                   a.y < b.y + b.height &&
                   a.y + a.height > b.y;
        }
        
        function updateUI() {
            goldDisplay.textContent = game.player.gold;
            healthDisplay.textContent = Math.floor(game.player.health);
        }
        
        function levelComplete() {
            game.isRunning = false;
            game.levelComplete = true;
            levelStats.innerHTML = `
                <div>Gold Collected: ${game.player.gold}</div>
                <div>Level Score: ${Math.floor(game.player.x)}</div>
            `;
            levelCompleteScreen.style.display = 'flex';
        }
        
        function gameOver() {
            game.isRunning = false;
            game.isGameOver = true;
            deathStats.innerHTML = `
                <div>Gold Collected: ${game.player.gold}</div>
                <div>Distance Traveled: ${Math.floor(game.player.x)}m</div>
                <div>Level Reached: ${game.currentLevel}</div>
            `;
            deathScreen.style.display = 'flex';
        }
        
        // Main Game Loop
        function gameLoop() {
            if (game.isRunning) {
                update();
                render();
                requestAnimationFrame(gameLoop);
            }
        }
    </script>
</body>
</html>
