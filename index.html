<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel Pirate Plunder</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a2e;
            overflow: hidden;
            touch-action: manipulation;
            font-family: 'Courier New', monospace;
            user-select: none;
            -webkit-user-select: none;
        }
        
        #gameCanvas {
            display: block;
            background: linear-gradient(to bottom, #0f0c29, #302b63);
            margin: 0 auto;
            image-rendering: pixelated;
        }
        
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            font-size: 18px;
            text-shadow: 2px 2px 2px #000;
            z-index: 10;
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            padding: 0 20px;
            box-sizing: border-box;
            z-index: 10;
        }
        
        .btn {
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #fff;
            border-radius: 10px;
            color: white;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: manipulation;
        }
        
        #titleScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #0f0c29, #302b63);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        #title {
            font-size: 48px;
            color: #f8c537;
            text-shadow: 4px 4px 0 #a82b2b;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        #startBtn {
            background: #f8c537;
            color: #1a1a2e;
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        #startBtn:active {
            transform: scale(0.95);
        }
        
        #levelScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: #f8c537;
        }
        
        #levelTitle {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        #levelDesc {
            font-size: 18px;
            margin-bottom: 30px;
            text-align: center;
            max-width: 80%;
        }
        
        #continueBtn {
            background: #f8c537;
            color: #1a1a2e;
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #deathScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: #f8c537;
        }
        
        #deathTitle {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        #restartBtn {
            background: #f8c537;
            color: #1a1a2e;
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #healthBar {
            height: 20px;
            background: #ff0000;
            border: 2px solid #fff;
            margin-top: 5px;
            transition: width 0.3s;
        }
        
        #healthBarContainer {
            width: 100px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="ui">
        <div>Gold: <span id="gold">0</span> | Level: <span id="level">1</span></div>
        <div>Health: <span id="health">100</span></div>
        <div id="healthBarContainer">
            <div id="healthBar" style="width: 100%;"></div>
        </div>
    </div>
    
    <div id="controls">
        <div class="btn" id="leftBtn">←</div>
        <div class="btn" id="upBtn">↑</div>
        <div class="btn" id="rightBtn">→</div>
        <div class="btn" id="downBtn">↓</div>
        <div class="btn" id="jumpBtn">JUMP</div>
        <div class="btn" id="attackBtn">ATTACK</div>
    </div>
    
    <div id="titleScreen">
        <div id="title">PIXEL PIRATE PLUNDER</div>
        <button id="startBtn">START ADVENTURE</button>
    </div>
    
    <div id="levelScreen">
        <div id="levelTitle">LEVEL <span id="levelNum">2</span></div>
        <div id="levelDesc">You discover a jungle temple with vine traps and poison dart enemies!</div>
        <button id="continueBtn">CONTINUE</button>
    </div>
    
    <div id="deathScreen">
        <div id="deathTitle">YARR, YE BE SUNK!</div>
        <div id="deathStats"></div>
        <button id="restartBtn">SAIL AGAIN</button>
    </div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Game elements
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    // UI elements
    const goldDisplay = document.getElementById("gold");
    const levelDisplay = document.getElementById("level");
    const healthDisplay = document.getElementById("health");
    const healthBar = document.getElementById("healthBar");
    const titleScreen = document.getElementById("titleScreen");
    const levelScreen = document.getElementById("levelScreen");
    const deathScreen = document.getElementById("deathScreen");
    const deathStats = document.getElementById("deathStats");
    const startBtn = document.getElementById("startBtn");
    const continueBtn = document.getElementById("continueBtn");
    const restartBtn = document.getElementById("restartBtn");
    
    // Control buttons
    const leftBtn = document.getElementById("leftBtn");
    const rightBtn = document.getElementById("rightBtn");
    const upBtn = document.getElementById("upBtn");
    const downBtn = document.getElementById("downBtn");
    const jumpBtn = document.getElementById("jumpBtn");
    const attackBtn = document.getElementById("attackBtn");
    
    // Game state
    let gameStarted = false;
    let currentLevel = 1;
    let maxLevel = 3;
    let gameOver = false;
    let levelComplete = false;
    let levelTransition = false;
    
    // Player properties
    const player = {
        x: 100,
        y: 300,
        width: 40,
        height: 60,
        vy: 0,
        vx: 0,
        gravity: 0.5,
        jumpPower: -15,
        grounded: false,
        speed: 5,
        maxHealth: 100,
        health: 100,
        gold: 0,
        xp: 0,
        level: 1,
        xpToNextLevel: 100,
        facing: 1, // 1 for right, -1 for left
        attacking: false,
        attackCooldown: 0,
        attackDuration: 15,
        attackRange: 60,
        damage: 20,
        invincible: false,
        invincibleTimer: 0,
        color: "#f8c537",
        hatColor: "#a82b2b",
        eyeColor: "#1a1a2e"
    };
    
    // Game objects
    let platforms = [];
    let enemies = [];
    let coins = [];
    let treasures = [];
    let projectiles = [];
    let traps = [];
    let levelExit = null;
    
    // Keys and controls
    const keys = {
        ArrowLeft: false,
        ArrowRight: false,
        ArrowUp: false,
        ArrowDown: false,
        Space: false,
        KeyZ: false
    };
    
    // Images for sprites
    const images = {
        player: null,
        enemy: null,
        coin: null,
        treasure: null,
        background: null
    };
    
    // Create simple placeholder images
    function createPlaceholderImages() {
        // Player image
        const playerCanvas = document.createElement("canvas");
        playerCanvas.width = 40;
        playerCanvas.height = 60;
        const playerCtx = playerCanvas.getContext("2d");
        
        // Body
        playerCtx.fillStyle = player.color;
        playerCtx.fillRect(5, 10, 30, 40);
        
        // Head
        playerCtx.fillStyle = "#ffdbac";
        playerCtx.fillRect(10, 0, 20, 20);
        
        // Eyes
        playerCtx.fillStyle = player.eyeColor;
        playerCtx.fillRect(14, 8, 4, 4);
        playerCtx.fillRect(22, 8, 4, 4);
        
        // Bandana
        playerCtx.fillStyle = player.hatColor;
        playerCtx.fillRect(10, 0, 20, 5);
        playerCtx.beginPath();
        playerCtx.moveTo(10, 5);
        playerCtx.lineTo(5, 10);
        playerCtx.lineTo(15, 10);
        playerCtx.closePath();
        playerCtx.fill();
        
        // Sword
        playerCtx.fillStyle = "#ccc";
        playerCtx.fillRect(35, 15, 5, 30);
        playerCtx.fillStyle = "#f8c537";
        playerCtx.fillRect(40, 15, 5, 5);
        
        images.player = playerCanvas;
        
        // Enemy image
        const enemyCanvas = document.createElement("canvas");
        enemyCanvas.width = 40;
        enemyCanvas.height = 50;
        const enemyCtx = enemyCanvas.getContext("2d");
        
        enemyCtx.fillStyle = "#a82b2b";
        enemyCtx.fillRect(5, 10, 30, 30);
        enemyCtx.fillStyle = "#333";
        enemyCtx.fillRect(10, 0, 20, 15);
        enemyCtx.fillStyle = "#fff";
        enemyCtx.fillRect(14, 5, 4, 4);
        enemyCtx.fillRect(22, 5, 4, 4);
        enemyCtx.fillStyle = "#ff0000";
        enemyCtx.fillRect(18, 10, 4, 2);
        
        images.enemy = enemyCanvas;
        
        // Coin image
        const coinCanvas = document.createElement("canvas");
        coinCanvas.width = 20;
        coinCanvas.height = 20;
        const coinCtx = coinCanvas.getContext("2d");
        
        coinCtx.fillStyle = "#f8c537";
        coinCtx.beginPath();
        coinCtx.arc(10, 10, 8, 0, Math.PI * 2);
        coinCtx.fill();
        coinCtx.strokeStyle = "#daa520";
        coinCtx.lineWidth = 2;
        coinCtx.stroke();
        
        images.coin = coinCanvas;
        
        // Treasure image
        const treasureCanvas = document.createElement("canvas");
        treasureCanvas.width = 30;
        treasureCanvas.height = 25;
        const treasureCtx = treasureCanvas.getContext("2d");
        
        treasureCtx.fillStyle = "#daa520";
        treasureCtx.fillRect(0, 5, 30, 15);
        treasureCtx.fillStyle = "#f8c537";
        treasureCtx.fillRect(5, 0, 20, 5);
        treasureCtx.fillStyle = "#a82b2b";
        treasureCtx.fillRect(12, 0, 6, 5);
        
        images.treasure = treasureCanvas;
    }
    
    // Initialize game
    function initGame() {
        createPlaceholderImages();
        setupControls();
        setupEventListeners();
        loadLevel(currentLevel);
        updateUI();
    }
    
    // Set up touch controls
    function setupControls() {
        leftBtn.addEventListener("touchstart", () => keys.ArrowLeft = true);
        leftBtn.addEventListener("touchend", () => keys.ArrowLeft = false);
        leftBtn.addEventListener("mousedown", () => keys.ArrowLeft = true);
        leftBtn.addEventListener("mouseup", () => keys.ArrowLeft = false);
        
        rightBtn.addEventListener("touchstart", () => keys.ArrowRight = true);
        rightBtn.addEventListener("touchend", () => keys.ArrowRight = false);
        rightBtn.addEventListener("mousedown", () => keys.ArrowRight = true);
        rightBtn.addEventListener("mouseup", () => keys.ArrowRight = false);
        
        upBtn.addEventListener("touchstart", () => keys.ArrowUp = true);
        upBtn.addEventListener("touchend", () => keys.ArrowUp = false);
        upBtn.addEventListener("mousedown", () => keys.ArrowUp = true);
        upBtn.addEventListener("mouseup", () => keys.ArrowUp = false);
        
        jumpBtn.addEventListener("touchstart", () => keys.ArrowUp = true);
        jumpBtn.addEventListener("touchend", () => keys.ArrowUp = false);
        jumpBtn.addEventListener("mousedown", () => keys.ArrowUp = true);
        jumpBtn.addEventListener("mouseup", () => keys.ArrowUp = false);
        
        attackBtn.addEventListener("touchstart", () => keys.KeyZ = true);
        attackBtn.addEventListener("touchend", () => keys.KeyZ = false);
        attackBtn.addEventListener("mousedown", () => keys.KeyZ = true);
        attackBtn.addEventListener("mouseup", () => keys.KeyZ = false);
    }
    
    // Set up event listeners
    function setupEventListeners() {
        startBtn.addEventListener("click", startGame);
        continueBtn.addEventListener("click", continueToNextLevel);
        restartBtn.addEventListener("click", restartGame);
        
        window.addEventListener("keydown", (e) => {
            if (e.code in keys) {
                keys[e.code] = true;
                e.preventDefault();
            }
        });
        
        window.addEventListener("keyup", (e) => {
            if (e.code in keys) {
                keys[e.code] = false;
                e.preventDefault();
            }
        });
        
        window.addEventListener("resize", () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    }
    
    // Load level
    function loadLevel(level) {
        // Reset game objects
        platforms = [];
        enemies = [];
        coins = [];
        treasures = [];
        projectiles = [];
        traps = [];
        levelExit = null;
        
        // Reset player position and state
        player.x = 100;
        player.y = 300;
        player.vy = 0;
        player.vx = 0;
        player.grounded = false;
        player.attacking = false;
        player.attackCooldown = 0;
        player.invincible = false;
        player.invincibleTimer = 0;
        
        // Common platform properties
        const platformHeight = 20;
        const platformColor = "#8B4513"; // Brown
        
        // Level-specific setup
        switch (level) {
            case 1:
                // Beach level
                document.getElementById("levelNum").textContent = level;
                document.getElementById("levelDesc").textContent = "A tropical beach with buried treasure and pirate skeletons!";
                
                // Ground
                platforms.push({
                    x: 0,
                    y: canvas.height - 50,
                    width: canvas.width,
                    height: 50,
                    color: "#5d8a66" // Sand color
                });
                
                // Platforms
                platforms.push({ x: 300, y: 400, width: 100, height: platformHeight, color: platformColor });
                platforms.push({ x: 500, y: 350, width: 100, height: platformHeight, color: platformColor });
                platforms.push({ x: 700, y: 300, width: 100, height: platformHeight, color: platformColor });
                
                // Coins
                for (let i = 0; i < 15; i++) {
                    coins.push({
                        x: Math.random() * (canvas.width - 40) + 20,
                        y: Math.random() * (canvas.height - 200) + 50,
                        width: 20,
                        height: 20,
                        value: 5,
                        collected: false
                    });
                }
                
                // Treasures
                treasures.push({ x: 800, y: 250, width: 30, height: 25, value: 50, collected: false });
                
                // Enemies
                enemies.push({
                    x: 400,
                    y: canvas.height - 50 - 50,
                    width: 40,
                    height: 50,
                    speed: 2,
                    health: 30,
                    damage: 10,
                    direction: 1,
                    color: "#a82b2b"
                });
                
                enemies.push({
                    x: 600,
                    y: canvas.height - 50 - 50,
                    width: 40,
                    height: 50,
                    speed: 1.5,
                    health: 40,
                    damage: 15,
                    direction: -1,
                    color: "#8b0000"
                });
                
                // Level exit
                levelExit = {
                    x: canvas.width - 100,
                    y: canvas.height - 50 - 60,
                    width: 50,
                    height: 60,
                    color: "#4169E1"
                };
                break;
                
            case 2:
                // Jungle level
                document.getElementById("levelNum").textContent = level;
                document.getElementById("levelDesc").textContent = "A dense jungle with vine traps and poison dart enemies!";
                
                // Ground
                platforms.push({
                    x: 0,
                    y: canvas.height - 50,
                    width: canvas.width,
                    height: 50,
                    color: "#2E8B57" // Jungle green
                });
                
                // Platforms
                platforms.push({ x: 200, y: 450, width: 80, height: platformHeight, color: platformColor });
                platforms.push({ x: 350, y: 400, width: 80, height: platformHeight, color: platformColor });
                platforms.push({ x: 500, y: 350, width: 80, height: platformHeight, color: platformColor });
                platforms.push({ x: 650, y: 400, width: 80, height: platformHeight, color: platformColor });
                platforms.push({ x: 800, y: 450, width: 80, height: platformHeight, color: platformColor });
                
                // Coins
                for (let i = 0; i < 20; i++) {
                    coins.push({
                        x: Math.random() * (canvas.width - 40) + 20,
                        y: Math.random() * (canvas.height - 200) + 50,
                        width: 20,
                        height: 20,
                        value: 5,
                        collected: false
                    });
                }
                
                // Treasures
                treasures.push({ x: 450, y: 320, width: 30, height: 25, value: 50, collected: false });
                treasures.push({ x: 750, y: 370, width: 30, height: 25, value: 50, collected: false });
                
                // Enemies
                enemies.push({
                    x: 300,
                    y: canvas.height - 50 - 50,
                    width: 40,
                    height: 50,
                    speed: 2.5,
                    health: 25,
                    damage: 15,
                    direction: 1,
                    color: "#006400",
                    shoots: true,
                    shootCooldown: 0,
                    shootInterval: 120
                });
                
                enemies.push({
                    x: 600,
                    y: canvas.height - 50 - 50,
                    width: 40,
                    height: 50,
                    speed: 2,
                    health: 35,
                    damage: 20,
                    direction: -1,
                    color: "#8b0000",
                    shoots: true,
                    shootCooldown: 60,
                    shootInterval: 120
                });
                
                // Traps (poison darts)
                traps.push({
                    x: 250,
                    y: 200,
                    width: 10,
                    height: 5,
                    active: true,
                    timer: 0,
                    interval: 90,
                    direction: "down",
                    speed: 8,
                    damage: 15
                });
                
                traps.push({
                    x: 550,
                    y: 200,
                    width: 10,
                    height: 5,
                    active: true,
                    timer: 0,
                    interval: 90,
                    direction: "down",
                    speed: 8,
                    damage: 15
                });
                
                // Level exit
                levelExit = {
                    x: canvas.width - 100,
                    y: canvas.height - 50 - 60,
                    width: 50,
                    height: 60,
                    color: "#4169E1"
                };
                break;
                
            case 3:
                // Cave level
                document.getElementById("levelNum").textContent = level;
                document.getElementById("levelDesc").textContent = "A dark cave filled with gold and dangerous pirates!";
                
                // Ground
                platforms.push({
                    x: 0,
                    y: canvas.height - 50,
                    width: canvas.width,
                    height: 50,
                    color: "#708090" // Slate gray
                });
                
                // Platforms
                platforms.push({ x: 150, y: 500, width: 70, height: platformHeight, color: platformColor });
                platforms.push({ x: 300, y: 400, width: 70, height: platformHeight, color: platformColor });
                platforms.push({ x: 450, y: 300, width: 70, height: platformHeight, color: platformColor });
                platforms.push({ x: 600, y: 400, width: 70, height: platformHeight, color: platformColor });
                platforms.push({ x: 750, y: 500, width: 70, height: platformHeight, color: platformColor });
                
                // Coins
                for (let i = 0; i < 25; i++) {
                    coins.push({
                        x: Math.random() * (canvas.width - 40) + 20,
                        y: Math.random() * (canvas.height - 200) + 50,
                        width: 20,
                        height: 20,
                        value: 5,
                        collected: false
                    });
                }
                
                // Treasures
                treasures.push({ x: 400, y: 270, width: 30, height: 25, value: 100, collected: false });
                treasures.push({ x: 700, y: 370, width: 30, height: 25, value: 100, collected: false });
                
                // Enemies
                enemies.push({
                    x: 200,
                    y: canvas.height - 50 - 50,
                    width: 40,
                    height: 50,
                    speed: 3,
                    health: 50,
                    damage: 25,
                    direction: 1,
                    color: "#8b0000",
                    shoots: true,
                    shootCooldown: 0,
                    shootInterval: 90
                });
                
                enemies.push({
                    x: 500,
                    y: canvas.height - 50 - 50,
                    width: 40,
                    height: 50,
                    speed: 3,
                    health: 50,
                    damage: 25,
                    direction: -1,
                    color: "#a82b2b",
                    shoots: true,
                    shootCooldown: 45,
                    shootInterval: 90
                });
                
                enemies.push({
                    x: 800,
                    y: canvas.height - 50 - 50,
                    width: 40,
                    height: 50,
                    speed: 2.5,
                    health: 60,
                    damage: 30,
                    direction: -1,
                    color: "#4B0082",
                    shoots: true,
                    shootCooldown: 30,
                    shootInterval: 90
                });
                
                // Traps (falling rocks)
                traps.push({
                    x: 350,
                    y: 0,
                    width: 30,
                    height: 30,
                    active: false,
                    timer: 0,
                    interval: 120,
                    direction: "down",
                    speed: 10,
                    damage: 20
                });
                
                traps.push({
                    x: 650,
                    y: 0,
                    width: 30,
                    height: 30,
                    active: false,
                    timer: 0,
                    interval: 120,
                    direction: "down",
                    speed: 10,
                    damage: 20
                });
                
                // Level exit
                levelExit = {
                    x: canvas.width - 100,
                    y: canvas.height - 50 - 60,
                    width: 50,
                    height: 60,
                    color: "#4169E1"
                };
                break;
        }
    }
    
    // Start game
    function startGame() {
        titleScreen.style.display = "none";
        gameStarted = true;
        gameOver = false;
        levelComplete = false;
        levelTransition = false;
        currentLevel = 1;
        
        // Reset player stats
        player.health = player.maxHealth;
        player.gold = 0;
        player.level = 1;
        player.xp = 0;
        player.xpToNextLevel = 100;
        
        loadLevel(currentLevel);
        updateUI();
        gameLoop();
    }
    
    // Continue to next level
    function continueToNextLevel() {
        levelScreen.style.display = "none";
        levelTransition = false;
        gameLoop();
    }
    
    // Restart game
    function restartGame() {
        deathScreen.style.display = "none";
        startGame();
    }
    
    // Update game state
    function update() {
        if (gameOver || levelTransition) return;
        
        // Player movement
        player.vx = 0;
        
        if (keys.ArrowLeft) {
            player.vx = -player.speed;
            player.facing = -1;
        }
        if (keys.ArrowRight) {
            player.vx = player.speed;
            player.facing = 1;
        }
        
        // Jumping
        if ((keys.ArrowUp || keys.Space) && player.grounded) {
            player.vy = player.jumpPower;
            player.grounded = false;
        }
        
        // Attacking
        if (keys.KeyZ && player.attackCooldown <= 0) {
            player.attacking = true;
            player.attackCooldown = player.attackDuration + 20; // Attack duration + cooldown
        }
        
        // Update attack state
        if (player.attacking) {
            if (player.attackCooldown <= player.attackDuration) {
                player.attacking = false;
            }
        }
        
        if (player.attackCooldown > 0) {
            player.attackCooldown--;
        }
        
        // Update invincibility
        if (player.invincible) {
            player.invincibleTimer--;
            if (player.invincibleTimer <= 0) {
                player.invincible = false;
            }
        }
        
        // Apply gravity
        player.vy += player.gravity;
        
        // Update position
        player.x += player.vx;
        player.y += player.vy;
        
        // Check boundaries
        if (player.x < 0) player.x = 0;
        if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
        
        // Platform collision
        player.grounded = false;
        for (const platform of platforms) {
            if (player.x + player.width > platform.x &&
                player.x < platform.x + platform.width &&
                player.y + player.height > platform.y &&
                player.y < platform.y + platform.height) {
                
                // Landing on top of platform
                if (player.vy > 0 && player.y + player.height < platform.y + platform.height / 2) {
                    player.y = platform.y - player.height;
                    player.vy = 0;
                    player.grounded = true;
                }
                // Hitting platform from below
                else if (player.vy < 0 && player.y > platform.y + platform.height / 2) {
                    player.y = platform.y + platform.height;
                    player.vy = 0;
                }
                // Hitting platform from left
                else if (player.vx > 0 && player.x + player.width > platform.x && player.x < platform.x) {
                    player.x = platform.x - player.width;
                }
                // Hitting platform from right
                else if (player.vx < 0 && player.x < platform.x + platform.width && player.x + player.width > platform.x + platform.width) {
                    player.x = platform.x + platform.width;
                }
            }
        }
        
        // Enemy movement and collision
        for (const enemy of enemies) {
            if (enemy.health <= 0) continue;
            
            // Simple AI - move back and forth
            enemy.x += enemy.speed * enemy.direction;
            
            // Change direction at edges or when hitting a wall
            let onPlatform = false;
            for (const platform of platforms) {
                if (enemy.x <= platform.x + platform.width &&
                    enemy.x + enemy.width >= platform.x &&
                    enemy.y + enemy.height >= platform.y &&
                    enemy.y + enemy.height <= platform.y + platform.height / 2) {
                    onPlatform = true;
                    
                    // Check if at edge of platform
                    if ((enemy.direction < 0 && enemy.x <= platform.x) ||
                        (enemy.direction > 0 && enemy.x + enemy.width >= platform.x + platform.width)) {
                        enemy.direction *= -1;
                    }
                    break;
                }
            }
            
            // If not on a platform, turn around
            if (!onPlatform) {
                enemy.direction *= -1;
            }
            
            // Shooting enemies
            if (enemy.shoots) {
                enemy.shootCooldown--;
                if (enemy.shootCooldown <= 0) {
                    // Shoot towards player
                    const dx = player.x - enemy.x;
                    const dy = player.y - enemy.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist < 500) { // Only shoot if player is within range
                        projectiles.push({
                            x: enemy.x + enemy.width / 2,
                            y: enemy.y + enemy.height / 2,
                            width: 10,
                            height: 5,
                            vx: (dx / dist) * 7,
                            vy: (dy / dist) * 7,
                            damage: enemy.damage / 2,
                            color: "#00ff00",
                            fromEnemy: true
                        });
                        enemy.shootCooldown = enemy.shootInterval;
                    }
                }
            }
            
            // Enemy collision with player
            if (!player.invincible && !player.attacking &&
                player.x + player.width > enemy.x &&
                player.x < enemy.x + enemy.width &&
                player.y + player.height > enemy.y &&
                player.y < enemy.y + enemy.height) {
                
                player.health -= enemy.damage;
                player.invincible = true;
                player.invincibleTimer = 60; // 1 second invincibility
                
                // Knockback
                if (player.x < enemy.x) {
                    player.vx = -10;
                } else {
                    player.vx = 10;
                }
                player.vy = -5;
                
                updateUI();
                
                if (player.health <= 0) {
                    gameOver = true;
                    showDeathScreen();
                    return;
                }
            }
            
            // Player attack hits enemy
            if (player.attacking && player.attackCooldown > player.attackDuration - 5) {
                const attackX = player.facing > 0 ? player.x + player.width : player.x - player.attackRange;
                const attackWidth = player.attackRange;
                
                if (attackX < enemy.x + enemy.width &&
                    attackX + attackWidth > enemy.x &&
                    player.y + player.height > enemy.y &&
                    player.y < enemy.y + enemy.height) {
                    
                    enemy.health -= player.damage;
                    if (enemy.health <= 0) {
                        player.xp += 20;
                        checkLevelUp();
                    }
                }
            }
        }
        
        // Projectile movement and collision
        for (let i = projectiles.length - 1; i >= 0; i--) {
            const proj = projectiles[i];
            proj.x += proj.vx;
            proj.y += proj.vy;
            
            // Remove projectiles that go off screen
            if (proj.x < 0 || proj.x > canvas.width || proj.y < 0 || proj.y > canvas.height) {
                projectiles.splice(i, 1);
                continue;
            }
            
            // Enemy projectiles hit player
            if (proj.fromEnemy && !player.invincible &&
                player.x + player.width > proj.x &&
                player.x < proj.x + proj.width &&
                player.y + player.height > proj.y &&
                player.y < proj.y + proj.height) {
                
                player.health -= proj.damage;
                player.invincible = true;
                player.invincibleTimer = 60;
                projectiles.splice(i, 1);
                
                // Knockback
                if (player.x < proj.x) {
                    player.vx = -8;
                } else {
                    player.vx = 8;
                }
                player.vy = -5;
                
                updateUI();
                
                if (player.health <= 0) {
                    gameOver = true;
                    showDeathScreen();
                    return;
                }
            }
            
            // Player attacks destroy enemy projectiles
            if (!proj.fromEnemy && player.attacking && player.attackCooldown > player.attackDuration - 5) {
                const attackX = player.facing > 0 ? player.x + player.width : player.x - player.attackRange;
                const attackWidth = player.attackRange;
                
                if (attackX < proj.x + proj.width &&
                    attackX + attackWidth > proj.x &&
                    player.y + player.height > proj.y &&
                    player.y < proj.y + proj.height) {
                    
                    projectiles.splice(i, 1);
                }
            }
        }
        
        // Trap logic
        for (const trap of traps) {
            trap.timer++;
            
            if (trap.timer >= trap.interval) {
                trap.active = !trap.active;
                trap.timer = 0;
                
                if (trap.active && trap.direction === "down") {
                    // Reset position for falling traps
                    trap.y = 0;
                }
            }
            
            // Trap movement
            if (trap.active) {
                if (trap.direction === "down") {
                    trap.y += trap.speed;
                    if (trap.y > canvas.height) {
                        trap.active = false;
                        trap.timer = 0;
                    }
                }
                
                // Trap collision with player
                if (!player.invincible &&
                    player.x + player.width > trap.x &&
                    player.x < trap.x + trap.width &&
                    player.y + player.height > trap.y &&
                    player.y < trap.y + trap.height) {
                    
                    player.health -= trap.damage;
                    player.invincible = true;
                    player.invincibleTimer = 60;
                    
                    // Knockback
                    if (trap.direction === "down") {
                        player.vy = -10;
                    }
                    
                    updateUI();
                    
                    if (player.health <= 0) {
                        gameOver = true;
                        showDeathScreen();
                        return;
                    }
                }
            }
        }
        
        // Coin collection
        for (let i = coins.length - 1; i >= 0; i--) {
            const coin = coins[i];
            if (!coin.collected &&
                player.x + player.width > coin.x &&
                player.x < coin.x + coin.width &&
                player.y + player.height > coin.y &&
                player.y < coin.y + coin.height) {
                
                coin.collected = true;
                player.gold += coin.value;
                coins.splice(i, 1);
                updateUI();
            }
        }
        
        // Treasure collection
        for (let i = treasures.length - 1; i >= 0; i--) {
            const treasure = treasures[i];
            if (!treasure.collected &&
                player.x + player.width > treasure.x &&
                player.x < treasure.x + treasure.width &&
                player.y + player.height > treasure.y &&
                player.y < treasure.y + treasure.height) {
                
                treasure.collected = true;
                player.gold += treasure.value;
                player.xp += 30;
                treasures.splice(i, 1);
                checkLevelUp();
                updateUI();
            }
        }
        
        // Level exit
        if (levelExit &&
            player.x + player.width > levelExit.x &&
            player.x < levelExit.x + levelExit.width &&
            player.y + player.height > levelExit.y &&
            player.y < levelExit.y + levelExit.height) {
            
            levelComplete = true;
            currentLevel++;
            
            if (currentLevel > maxLevel) {
                // Game completed
                showDeathScreen(true);
            } else {
                showLevelScreen();
            }
        }
    }
    
    // Check for level up
    function checkLevelUp() {
        if (player.xp >= player.xpToNextLevel) {
            player.level++;
            player.xp -= player.xpToNextLevel;
            player.xpToNextLevel = Math.floor(player.xpToNextLevel * 1.5);
            player.maxHealth += 20;
            player.health = player.maxHealth;
            player.damage += 5;
            updateUI();
        }
    }
    
    // Update UI
    function updateUI() {
        goldDisplay.textContent = player.gold;
        levelDisplay.textContent = player.level;
        healthDisplay.textContent = player.health;
        healthBar.style.width = `${(player.health / player.maxHealth) * 100}%`;
    }
    
    // Show level screen
    function showLevelScreen() {
        levelTransition = true;
        levelScreen.style.display = "flex";
    }
    
    // Show death screen
    function showDeathScreen(victory = false) {
        if (victory) {
            deathTitle.textContent = "YARR, YE BE VICTORIOUS!";
            deathStats.innerHTML = `
                <div>Final Gold: ${player.gold}</div>
                <div>Level Reached: ${player.level}</div>
                <div>Enemies Defeated: ${(currentLevel - 1) * 2 + 1}</div>
            `;
        } else {
            deathTitle.textContent = "YARR, YE BE SUNK!";
            deathStats.innerHTML = `
                <div>Gold Collected: ${player.gold}</div>
                <div>Level Reached: ${currentLevel}</div>
                <div>XP: ${player.xp}/${player.xpToNextLevel}</div>
            `;
        }
        
        deathScreen.style.display = "flex";
    }
    
    // Draw game
    function draw() {
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw background
        ctx.fillStyle = "#0f0c29";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Draw platforms
        for (const platform of platforms) {
            ctx.fillStyle = platform.color;
            ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
        }
        
        // Draw level exit
        if (levelExit) {
            ctx.fillStyle = levelExit.color;
            ctx.fillRect(levelExit.x, levelExit.y, levelExit.width, levelExit.height);
            
            // Draw door details
            ctx.fillStyle = "#f8c537";
            ctx.fillRect(levelExit.x + 15, levelExit.y + 10, 20, 40);
        }
        
        // Draw coins
        for (const coin of coins) {
            if (!coin.collected) {
                ctx.drawImage(images.coin, coin.x, coin.y, coin.width, coin.height);
            }
        }
        
        // Draw treasures
        for (const treasure of treasures) {
            if (!treasure.collected) {
                ctx.drawImage(images.treasure, treasure.x, treasure.y, treasure.width, treasure.height);
            }
        }
        
        // Draw enemies
        for (const enemy of enemies) {
            if (enemy.health > 0) {
                // Draw enemy
                ctx.save();
                if (enemy.direction < 0) {
                    ctx.translate(enemy.x + enemy.width, enemy.y);
                    ctx.scale(-1, 1);
                    ctx.drawImage(images.enemy, 0, 0, enemy.width, enemy.height);
                } else {
                    ctx.drawImage(images.enemy, enemy.x, enemy.y, enemy.width, enemy.height);
                }
                ctx.restore();
                
                // Draw health bar
                const healthPercent = enemy.health / (enemy.width === 40 ? (currentLevel === 3 ? 60 : 40) : 30);
                ctx.fillStyle = "#ff0000";
                ctx.fillRect(enemy.x, enemy.y - 10, enemy.width, 5);
                ctx.fillStyle = "#00ff00";
                ctx.fillRect(enemy.x, enemy.y - 10, enemy.width * healthPercent, 5);
            }
        }
        
        // Draw projectiles
        for (const proj of projectiles) {
            ctx.fillStyle = proj.color;
            ctx.fillRect(proj.x, proj.y, proj.width, proj.height);
        }
        
        // Draw traps
        for (const trap of traps) {
            if (trap.active) {
                ctx.fillStyle = "#555";
                ctx.fillRect(trap.x, trap.y, trap.width, trap.height);
            }
        }
        
        // Draw player
        ctx.save();
        if (player.facing < 0) {
            ctx.translate(player.x + player.width, player.y);
            ctx.scale(-1, 1);
            ctx.drawImage(images.player, 0, 0, player.width, player.height);
        } else {
            ctx.drawImage(images.player, player.x, player.y, player.width, player.height);
        }
        
        // Draw attack effect
        if (player.attacking && player.attackCooldown > player.attackDuration - 5) {
            ctx.fillStyle = "rgba(255, 255, 0, 0.5)";
            const attackX = player.facing > 0 ? player.x + player.width : player.x - player.attackRange;
            ctx.fillRect(attackX, player.y, player.attackRange, player.height);
        }
        ctx.restore();
        
        // Draw invincibility effect
        if (player.invincible && Math.floor(player.invincibleTimer / 5) % 2 === 0) {
            ctx.strokeStyle = "rgba(255, 255, 255, 0.7)";
            ctx.lineWidth = 3;
            ctx.strokeRect(player.x - 2, player.y - 2, player.width + 4, player.height + 4);
        }
    }
    
    // Main game loop
    function gameLoop() {
        if (!gameStarted || gameOver || levelTransition) return;
        
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }
    
    // Initialize the game
    initGame();
});
</script>
</body>
</html>
